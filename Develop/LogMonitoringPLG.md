# PLG 스택 간단 가이드
## Prometheus + Loki + Grafana 모니터링 시스템

---

## 📌 PLG 스택이란?

**PLG 스택**은 오픈소스 기반의 모니터링 시스템으로, 세 가지 도구를 조합한 것입니다.

```
애플리케이션
    │
    ├──► Prometheus (메트릭 수집)
    ├──► Loki (로그 수집)
    │
    └──► Grafana (시각화)
```

---

## 🔍 각 컴포넌트 역할

### 1. Prometheus (프로메테우스)

**역할**: 메트릭(숫자 데이터) 수집 및 저장

**무엇을 모니터링하나?**
- CPU 사용률
- 메모리 사용량
- HTTP 요청 수
- 응답 시간
- 에러 발생 횟수

**핵심 특징**:
- Pull 방식: Prometheus가 주기적으로 애플리케이션에서 메트릭을 가져옴
- 시계열 데이터베이스: 시간별로 데이터 저장
- PromQL: 강력한 쿼리 언어

**예시**:
```
http_requests_total{method="GET", status="200"} = 1523
cpu_usage_percent = 75.3
memory_used_bytes = 2147483648
```

**비유**: 건강검진 - 주기적으로 혈압, 체온, 맥박 등을 측정

---

### 2. Loki (로키)

**역할**: 로그(텍스트 데이터) 수집 및 저장

**무엇을 수집하나?**
- 애플리케이션 로그
- 에러 메시지
- 요청/응답 로그
- 시스템 로그

**핵심 특징**:
- 로그 내용은 인덱싱 안 함 (레이블만 인덱싱)
- 저렴한 스토리지 비용
- Prometheus와 유사한 쿼리 방식 (LogQL)

**기존 방식(ELK)과의 차이**:
```
ELK:
로그 한 줄의 모든 단어를 인덱싱
→ 검색 빠름, 저장 공간 많이 필요 (비쌈)

Loki:
레이블만 인덱싱 (예: app="user-service", level="error")
→ 저장 공간 적음 (저렴), 전문 검색은 느림
```

**예시**:
```
[ERROR] 2024-01-15 10:30:45 Database connection failed
[INFO] 2024-01-15 10:30:46 User login successful
[WARN] 2024-01-15 10:30:47 Slow query detected
```

**비유**: CCTV 녹화 - 영상을 계속 저장하되, 중요한 부분만 태그(레이블) 달기

---

### 3. Grafana (그라파나)

**역할**: 데이터 시각화 대시보드

**무엇을 하나?**
- Prometheus의 메트릭을 그래프로 표시
- Loki의 로그를 보기 좋게 표시
- 여러 데이터를 하나의 화면에 통합
- 알림 설정

**핵심 특징**:
- 다양한 데이터 소스 지원
- 커스터마이징 가능한 대시보드
- 실시간 모니터링
- 알림 기능

**대시보드 예시**:
```
┌─────────────────────────────────────┐
│  CPU: 75% │ 메모리: 8GB │ 요청: 1523│  ← Prometheus 메트릭
├─────────────────────────────────────┤
│  [응답시간 그래프]                   │  ← Prometheus 메트릭
│  [요청수 그래프]                     │  ← Prometheus 메트릭
├─────────────────────────────────────┤
│  [최근 에러 로그]                    │  ← Loki 로그
│  ERROR: Connection timeout          │
│  ERROR: Invalid user                │
└─────────────────────────────────────┘
```

**비유**: 자동차 계기판 - 속도, RPM, 연료 등을 한눈에 보여줌

---

## 🎯 전체 동작 흐름

```
1. 애플리케이션 실행
   ↓
2. Prometheus가 15초마다 메트릭 수집
   "지금 CPU 몇 %야?" → "75%입니다"
   ↓
3. Promtail(Loki 에이전트)이 로그 수집
   로그 파일 감시 → Loki에 전송
   ↓
4. Grafana에서 데이터 조회
   - Prometheus에 쿼리: "최근 5분간 CPU 사용률?"
   - Loki에 쿼리: "ERROR 레벨 로그 보여줘"
   ↓
5. 대시보드에 표시
   그래프, 표, 로그 등으로 시각화
```

---

## ✅ 장점

### 1. 완전 무료 & 오픈소스
- 소프트웨어 비용 0원
- 서버 비용만 필요

### 2. 저렴한 운영 비용
- Loki는 저장 공간이 적게 필요 (ELK의 10% 수준)
- 적은 리소스로 운영 가능

### 3. 통합 시각화
- 메트릭과 로그를 한 화면에서 확인
- 문제 발생 시 빠른 원인 파악

### 4. 쉬운 설치
- Docker Compose로 5분 안에 구축 가능

### 5. 확장성
- 서버를 추가하면서 확장 가능
- Kubernetes와 잘 어울림

---

## ❌ 단점

### 1. 로그 전문 검색 느림
- Loki는 로그 내용을 인덱싱하지 않음
- "모든 로그에서 'timeout' 검색" → 느림
- 레이블 기반 필터링만 빠름

### 2. 학습 곡선
- PromQL, LogQL 배워야 함
- 대시보드 작성 연습 필요

### 3. 장기 보관은 추가 설정 필요
- 기본: 15-30일만 저장
- 더 오래 보관하려면 S3 등 연동 필요

### 4. 고가용성(HA) 구성 복잡
- 서버 2개 이상 운영하려면 복잡한 설정

---

## 📊 다른 모니터링 스택과 비교

### PLG vs ELK

| 항목 | PLG | ELK |
|------|-----|-----|
| **로그 검색** | 🐢 느림 | 🚀 빠름 |
| **스토리지 비용** | 💰 저렴 | 💰💰💰 비쌈 |
| **설치 난이도** | ✅ 쉬움 | ⚠️ 복잡 |
| **메트릭** | ✅ Prometheus 내장 | ❌ 별도 도구 필요 |
| **리소스 사용** | ✅ 적음 | ❌ 많음 |

### PLG vs 상용 솔루션 (DataDog, New Relic)

| 항목 | PLG | 상용 솔루션 |
|------|-----|-----------|
| **비용** | 💰 무료 | 💰💰💰 비쌈 |
| **관리** | ⚠️ 직접 관리 | ✅ 관리 불필요 |
| **지원** | 커뮤니티 | 24/7 기술 지원 |
| **기능** | 기본 | 고급 |

---

## 🎯 언제 PLG를 써야 할까?

### ✅ PLG를 쓰면 좋을 때

1. **예산이 제한적일 때**
   - 스타트업, 개인 프로젝트

2. **중소규모 서비스**
   - 서버 10-50대
   - 로그 하루 10-100GB

3. **Kubernetes 사용 중**
   - PLG는 Kubernetes와 궁합이 좋음

4. **직접 관리할 인력이 있을 때**
   - DevOps 엔지니어 있음

### ❌ PLG가 적합하지 않을 때

1. **대규모 로그 검색이 중요할 때**
   - 로그에서 특정 단어 자주 검색
   - → ELK Stack 추천

2. **관리 인력이 없을 때**
   - → DataDog, New Relic 같은 상용 솔루션

3. **24/7 기술 지원이 필요할 때**
   - 중요한 금융/의료 시스템

---

## 📝 요약

### Prometheus
- **역할**: 메트릭(숫자) 수집
- **예시**: CPU, 메모리, 요청 수, 응답 시간
- **특징**: Pull 방식, 시계열 DB

### Loki
- **역할**: 로그(텍스트) 수집
- **예시**: 에러 메시지, 요청 로그
- **특징**: 레이블만 인덱싱 (저렴)

### Grafana
- **역할**: 시각화 대시보드
- **기능**: 그래프, 표, 알림
- **특징**: 통합 뷰

### PLG의 핵심 가치
✅ **무료** - 오픈소스  
✅ **저렴** - 적은 리소스  
✅ **간편** - 쉬운 설치  
✅ **통합** - 메트릭 + 로그 한 화면  

---

## 🚀 시작하기

가장 빠른 시작 방법:

```bash
# Docker Compose로 한 번에 설치
git clone https://github.com/grafana/loki
cd loki/production
docker-compose up -d

# Grafana 접속
http://localhost:3000
```

끝! 🎉